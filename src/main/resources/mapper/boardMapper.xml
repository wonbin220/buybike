<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.buybike.app.repository.BoardMapper">

<!--    <insert id="insert" parameterType="com.buybike.app.domain.Board" useGeneratedKeys="true" keyProperty="id">-->
<!--        INSERT INTO board (memberId, title, content, regDt)-->
<!--        VALUES (#{memberId}, #{title}, #{content}, NOW())-->
<!--    </insert>-->

<!--    <select id="findAll" resultType="com.buybike.app.domain.Board">-->
<!--        SELECT id, memberId, title, content, hit, regDt-->
<!--        FROM board-->
<!--        ORDER BY id DESC-->
<!--    </select>-->

<!--    <select id="findById" parameterType="long" resultType="com.buybike.app.domain.Board">-->
<!--        SELECT id, memberId, title, content, hit, regDt-->
<!--        FROM board-->
<!--        WHERE id = #{id}-->
<!--    </select>-->

<!--    <update.html id="update.html" parameterType="com.buybike.app.domain.Board">-->
<!--        UPDATE board-->
<!--        SET memberId = #{memberId},-->
<!--            title = #{title},-->
<!--            content = #{content},-->
<!--            regDt = NOW()-->
<!--        WHERE id = #{id}-->
<!--    </update.html>-->


    <!-- 목록 -->
<!--    <select id="list" resultType="com.buybike.app.domain.Board">-->
<!--        SELECT *-->
<!--        FROM board-->
<!--        ORDER BY no DESC-->
<!--    </select>-->
    <!-- boardMapper.xml -->
    <select id="list" resultType="com.buybike.app.domain.Board">
        SELECT
            b.no,
            b.title,
            b.memberId AS memberId,
            b.created_at AS createdAt,
            b.updated_at AS updatedAt,
            b.is_notice as isNotice,
--             b.hits,
            (SELECT COUNT(*) FROM comment c WHERE c.board_no = b.no AND c.is_deleted = FALSE) AS commentCount
        FROM
            board b
        ORDER BY
            b.no DESC
    </select>


    <!-- 페이징 목록 -->
    <select id="page" resultType="com.buybike.app.domain.Board">
        SELECT *
        FROM board
        LIMIT #{index}, #{size}
    </select>

    <!-- 조회 -->
    <select id="select" resultType="com.buybike.app.domain.Board">
        SELECT *
        FROM board
        WHERE no = #{no}
    </select>

    <!-- 게시글 목록 조회를 위한 select 구문 -->
    <select id="findAll" resultType="com.buybike.app.domain.Board">
        SELECT
        b.no,
        b.title,
        b.memberId AS memberId,
        b.created_at AS createdAt,
        b.updated_at AS updatedAt,
        b.is_notice as isNotice,
        (SELECT COUNT(*) FROM comment c WHERE c.board_no = b.no AND c.is_deleted = FALSE) AS commentCount
        FROM
        board b
        ORDER BY
        b.no DESC  <!-- b.board_no -> b.no 로 수정 -->
    </select>

    <!-- 등록 -->
    <insert id="insert">
        INSERT INTO board ( title, memberId, content, is_notice )
        VALUES ( #{title}, #{memberId}, #{content}, #{isNotice} )
    </insert>

    <!-- 수정 -->
    <update id="update">
        UPDATE board
        SET title = #{title}
          ,content = #{content}
          ,is_notice = #{isNotice}
        WHERE no = #{no}
    </update>

    <!-- 삭제 -->
    <delete id="delete">
        DELETE FROM board WHERE no = #{no}
    </delete>

    <!-- 데이터 수 -->
    <select id="count" resultType="long">
        SELECT COUNT(*)
        FROM board
    </select>

    <!-- 특정 회원이 작성한 게시글 목록 조회 -->
    <select id="getPostsByMemberId" resultType="com.buybike.app.domain.Board">
        SELECT
            no,
            id,
            title,
            created_at,
            comment_count,
            is_notice as isNotice
        FROM
            board
        WHERE
            memberId = #{memberId}
        ORDER BY
            id DESC
    </select>

    <!-- 카테고리별 게시글 목록 조회 -->
    <select id="listByCategory" resultType="com.buybike.app.domain.Board">
        SELECT
        b.no,
        b.title,
        b.memberId AS memberId,
        b.created_at AS createdAt,
        b.updated_at AS updatedAt,
        b.is_notice AS isNotice,
        (SELECT COUNT(*) FROM comment c WHERE c.board_no = b.no AND c.is_deleted = FALSE) AS commentCount
        FROM
        board b
        <where>
            <choose>
                <when test="category == 'notice'">
                    AND b.is_notice = TRUE
                </when>
                <when test="category == 'general'">
                    AND b.is_notice = FALSE
                </when>
                <otherwise>
                    AND b.is_notice = FALSE
                </otherwise>
            </choose>
        </where>
        ORDER BY
        b.no DESC
    </select>

    <!-- 공지사항 목록 조회 (최대 3개) -->
    <select id="findNotices" resultType="com.buybike.app.domain.Board">
        SELECT
        b.no,
        b.title,
        b.memberId AS memberId,
        b.created_at AS createdAt,
        b.updated_at AS updatedAt,
        b.is_notice AS isNotice,
        (SELECT COUNT(*) FROM comment c WHERE c.board_no = b.no AND c.is_deleted = FALSE) AS commentCount
        FROM
        board b
        WHERE
        b.is_notice = TRUE
        ORDER BY
        b.no DESC
        LIMIT 3
    </select>


<!--    &lt;!&ndash; 페이징 및 정렬된 게시글 목록 조회 &ndash;&gt;-->
<!--    <select id="findAllWithPaging" resultType="Board">-->
<!--        SELECT boardId, memberId, title, content, hit, regDt-->
<!--        FROM board-->
<!--        ORDER BY ${sortField} ${sortDir}-->
<!--        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}-->
<!--    </select>-->

<!--    <select id="getListBoard" parameterType="PageList" resultType="Board">-->
<!--        select boardId, title, content, memberId, regDt-->
<!--        from board-->
<!--        <where>-->
<!--            <if test="data.title != null and data.title != ''">-->
<!--                and title like '%' || #{data.title} || '%'-->
<!--            </if>-->
<!--            <if test="data.meberId != null and data.memberId != ''">-->
<!--                AND memberId LIKE '%' || #{data.memberId} || '%'-->
<!--            </if>-->
<!--        </where>-->
<!--    offset #{pageable.offset} rows fetch next #{pageable.pageSize} rows only-->
<!--    </select>-->

<!--    <select id="getListBoardCount" parameterType="Board" resultType="int">-->
<!--        select count(*) as cnt-->
<!--        from board-->
<!--        <where>-->
<!--            <if test="title != null anl title != ''">-->
<!--                and title like '%' || #{title} || '%'-->
<!--            </if>-->
<!--            <if test="memberId != null and memberId != ''">-->
<!--                AND memberId LIKE '%' || #{memberId} || '%'-->
<!--            </if>-->
<!--        </where>-->
<!--    </select>-->

</mapper>