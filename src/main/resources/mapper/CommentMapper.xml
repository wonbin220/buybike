<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.buybike.app.mapper.CommentMapper">

    <!-- 특정 게시글의 댓글 목록 조회 -->
    <select id="findByBoardNo" resultType="com.buybike.app.dto.CommentDto">
        SELECT
            comment_no, board_no, parent_no, depth, content,
            writer_id, is_deleted, is_secret, created_at
        FROM
            comment
        WHERE
            board_no = #{boardNo}
        ORDER BY
            -- 최상위 댓글(parent_no IS NULL)을 먼저 정렬하고,
            -- 그 다음 자식 댓글들을 순서대로 정렬합니다.
            COALESCE(parent_no, comment_no), comment_no
    </select>

    <!-- 댓글 번호로 댓글 조회 -->
    <select id="findByCommentNo" resultType="com.buybike.app.dto.CommentDto">
        SELECT
            comment_no, board_no, parent_no, depth, content,
            writer_id, is_deleted, is_secret, created_at
        FROM
            comment
        WHERE
            comment_no = #{commentNo}
    </select>

    <!-- 댓글 저장 -->
    <insert id="save" useGeneratedKeys="true" keyProperty="commentNo">
        INSERT INTO comment (board_no, parent_no, depth, content, writer_id, is_secret)
        VALUES (#{boardNo}, #{parentNo}, #{depth}, #{content}, #{writerId}, #{isSecret})
    </insert>

    <!-- 댓글 수정 -->
    <update id="update">
        UPDATE comment
        SET
            content = #{content},
            is_secret = #{isSecret},
            updated_at = CURRENT_TIMESTAMP
        WHERE
            comment_no = #{commentNo}
    </update>

    <!-- 댓글 삭제 (논리적 삭제) -->
    <update id="softDelete">
        UPDATE comment
        SET
            is_deleted = TRUE,
            content = '삭제된 댓글입니다.'
        WHERE
            comment_no = #{commentNo}
    </update>

</mapper>